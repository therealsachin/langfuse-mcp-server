echo "üîç Running pre-commit security checks..."

# Check for potential secrets in staged files
echo "üîê Checking for potential credentials..."

# Check for Langfuse API keys (real format: pk-lf-uuid, sk-lf-uuid) in ADDED lines only
if git diff --cached | grep -E '^\+.*' | grep -E '(pk-lf-[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}|sk-lf-[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})'; then
    echo "‚ùå ERROR: Real Langfuse API credentials detected in staged files!"
    echo "   Please remove them and use environment variables instead."
    exit 1
fi

# Check for other common secrets patterns in ADDED lines only
if git diff --cached | grep -E '^\+.*' | grep -E -i '(password|secret|token|api_key|access_key).*[:=]\s*["\'"'"'][^"'"'"']{8,}["\'"'"']'; then
    echo "‚ùå ERROR: Potential secrets detected in staged files!"
    echo "   Please review and remove sensitive data."
    exit 1
fi

# Check for .env files being committed (should be in .gitignore)
if git diff --cached --name-only | grep -E '^\.env$|^\.env\..*$'; then
    echo "‚ùå ERROR: .env file detected in staged files!"
    echo "   .env files should never be committed. Add them to .gitignore."
    exit 1
fi

# Check for files that should be in .gitignore
FORBIDDEN_FILES=$(git diff --cached --name-only | grep -E '\.(langfuse\.json|credentials\.json)$')
if [ ! -z "$FORBIDDEN_FILES" ]; then
    echo "‚ùå ERROR: Sensitive files detected:"
    echo "$FORBIDDEN_FILES"
    echo "   These files should be in .gitignore, not committed."
    exit 1
fi

# Run build to ensure code compiles
echo "üî® Running build check..."
if ! npm run build; then
    echo "‚ùå ERROR: Build failed!"
    echo "   Please fix TypeScript compilation errors before committing."
    exit 1
fi

# Optional: Run tests but don't fail on test failures (due to test data dependency)
echo "üß™ Running tests (informational)..."
npm test || echo "‚ö†Ô∏è  Tests failed - this may be due to missing test data, not code issues"

# If we get here, all security checks passed
echo "‚úÖ All pre-commit security checks passed!"